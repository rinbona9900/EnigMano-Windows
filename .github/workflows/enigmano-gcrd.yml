name: "âš¡ EnigMano GCRD Windows 10"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number"
        required: true
        default: "1"
      SSH_CODE_OR_CMD:
        description: "Paste the entire 'Setup via SSH' command OR just the OAuth code"
        required: true
        default: ""
      GCRD_PIN:
        description: "PIN (â‰¥6 digits). Leave blank to use digits derived from 'EnigMano'"
        required: false
        default: ""
      NEW_USERNAME:
        description: "Create this admin (leave blank to use runneradmin)"
        required: false
        default: ""
      NEW_PASSWORD:
        description: "Password for NEW_USERNAME (ignored if blank)"
        required: false
        default: ""
      GCRD_REDIRECT_URL:
        description: "Redirect URL (leave default unless Google changes it)"
        required: false
        default: "https://remotedesktop.google.com/_/oauthredirect"

jobs:
  deploy-enigmano:
    name: "ğŸš€ Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      REPO: ${{ github.repository }}
      DEPLOYMENT_ID: ${{ github.run_id }}
      WORKFLOW_FILE: "enigmano-gcrd.yml"

      SSH_CODE_OR_CMD: ${{ github.event.inputs.SSH_CODE_OR_CMD }}
      GCRD_PIN_INPUT: ${{ github.event.inputs.GCRD_PIN }}
      NEW_USERNAME_INPUT: ${{ github.event.inputs.NEW_USERNAME }}
      NEW_PASSWORD_INPUT: ${{ github.event.inputs.NEW_PASSWORD }}
      GCRD_REDIRECT_URL_INPUT: ${{ github.event.inputs.GCRD_REDIRECT_URL }}

    steps:
      # 1) Warm-up + Normalize inputs (code/redirect/pin/user) + Defaults
      - name: "âœ¨ Warm-Up (50s) & Normalize"
        shell: pwsh
        run: |
          Write-Host "ğŸ•’ Warming up runner for 50 seconds..."
          Start-Sleep -Seconds 50

          function Fail($m){ Write-Error $m; exit 1 }

          # Parse OAuth code (accept full command or just code)
          $raw = $env:SSH_CODE_OR_CMD
          if (-not $raw) { Fail "Missing SSH_CODE_OR_CMD." }
          $code = $null
          if ($raw -match '--code="([^"]+)"') {
            $code = $Matches[1]
          } elseif ($raw -match '^\s*"%PROGRAMFILES\(X86\)%\\Google\\Chrome Remote Desktop\\CurrentVersion\\remoting_start_host\.exe"') {
            Fail "Could not parse --code from the provided command. Paste full command again or just the code."
          } else {
            $code = $raw.Trim()
          }
          if (-not $code) { Fail "Empty OAuth code after parsing." }

          # Redirect URL
          $redirect = $env:GCRD_REDIRECT_URL_INPUT
          if (-not $redirect) { $redirect = "https://remotedesktop.google.com/_/oauthredirect" }
          if ($raw -match '--redirect-url="([^"]+)"') { $redirect = $Matches[1] }

          # PIN (numeric â‰¥6) or derived from "EnigMano"
          function Convert-ToT9($text){
            $map = @{
              'A'=2;'B'=2;'C'=2; 'D'=3;'E'=3;'F'=3; 'G'=4;'H'=4;'I'=4;
              'J'=5;'K'=5;'L'=5; 'M'=6;'N'=6;'O'=6; 'P'=7;'Q'=7;'R'=7;'S'=7;
              'T'=8;'U'=8;'V'=8; 'W'=9;'X'=9;'Y'=9;'Z'=9
            }
            ($text.ToUpper().ToCharArray() | ForEach-Object {
              if ($map.ContainsKey($_)) { $map[$_] }
              elseif ($_ -match '\d') { $_ }
            }) -join ''
          }
          $userPin = $env:GCRD_PIN_INPUT
          if ($userPin -and ($userPin -match '^\d{6,}$')) {
            $pin = $userPin
          } else {
            $t9 = Convert-ToT9 "EnigMano"   # 3644266
            $pin = if ($t9 -and $t9.Length -ge 6) { $t9 } else { "919191" }
          }

          # Choose target user:
          # - If NEW_USERNAME provided: use NEW_USERNAME + NEW_PASSWORD (required)
          # - Else use runneradmin with password Enigman0 (per your plan)
          if ($env:NEW_USERNAME_INPUT) {
            $user = $env:NEW_USERNAME_INPUT
            if (-not $env:NEW_PASSWORD_INPUT) { Fail "NEW_PASSWORD is required when NEW_USERNAME is provided." }
            $pass = $env:NEW_PASSWORD_INPUT
          } else {
            $user = "runneradmin"
            $pass = "Enigman0"
          }

          # Export for next steps
          "GCRD_CODE=$code"         | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "GCRD_REDIRECT=$redirect" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "GCRD_PIN=$pin"           | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TARGET_USER=$user"       | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TARGET_PASS=$pass"       | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # Mask sensitive
          Write-Host "::add-mask::$code"
          Write-Host "::add-mask::$pass"
          Write-Host "::add-mask::$pin"

          Write-Host ("âœ… Normalized: User=" + $user + " | Redirect=" + $redirect + " | PIN=(hidden)")

      # 2) Ensure admin (runneradmin -> Enigman0 OR create new) + Enable RDP (protocol + firewall + groups)
      - name: "ğŸ›¡ï¸ Ensure Admin & Enable RDP"
        shell: pwsh
        run: |
          function Ensure-Admin-NetOnly($u,$p){
            if ($u -ieq "runneradmin") {
              # Reset built-in GH admin password to plan's value
              & net user runneradmin $p /y | Out-Null
              & net user runneradmin /active:yes | Out-Null
            } else {
              # Create a new local admin
              & net user $u $p /add /y | Out-Null
              & net localgroup administrators $u /add | Out-Null
              & net user $u /active:yes | Out-Null
            }
            # Also grant RDP group membership
            & net localgroup "Remote Desktop Users" $u /add | Out-Null
            Write-Host "ğŸ‘¤ Admin ready: $u"
          }

          Ensure-Admin-NetOnly -u $env:TARGET_USER -p $env:TARGET_PASS

          # Enable RDP protocol + firewall
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1 -PropertyType DWord -Force | Out-Null
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "ğŸªŸ RDP enabled and firewall opened."

      # 3) Install Chrome Remote Desktop Host & resolve path
      - name: "â¬‡ï¸ Install CRD Host"
        shell: pwsh
        run: |
          function Fail($m){ Write-Error $m; exit 1 }
          $url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $msi = Join-Path $env:TEMP "chromeremotedesktophost.msi"
          Write-Host "ğŸŒ Downloading CRD Host MSI..."
          Invoke-WebRequest -Uri $url -OutFile $msi -UseBasicParsing
          Write-Host "âš™ï¸ Installing (silent)..."
          $p = Start-Process -FilePath "msiexec.exe" -ArgumentList "/i `"$msi`" /qn /norestart" -Wait -PassThru
          if ($p.ExitCode -ne 0) { Fail "CRD Host install failed with exit code $($p.ExitCode)" }
          Write-Host "âœ… CRD Host installed."

          $x86 = Join-Path ${env:ProgramFiles(x86)} "Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          $x64 = Join-Path ${env:ProgramFiles} "Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          $exe = if (Test-Path $x86) { $x86 } elseif (Test-Path $x64) { $x64 } else { "" }
          if (-not $exe) { Fail "remoting_start_host.exe not found after installation." }
          "CRD_EXE=$exe" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host ("ğŸ“ CRD Path: " + $exe)

      # 4) Register CRD using elevated Scheduled Task (wrapper) + verify w/ logs and service checks
      - name: "ğŸ” Register CRD via Wrapper Task & Verify"
        shell: pwsh
        run: |
          function Fail($m){ Write-Error $m; exit 1 }

          # Short wrapper to bypass schtasks /TR length limit and capture logs
          $wrapper = Join-Path $env:WINDIR "Temp\enigmano-crd-register.ps1"
          $logPath = Join-Path $env:WINDIR "Temp\enigmano-crd-register.log"

          $lines = @(
            '$ErrorActionPreference = "Continue"'
            '$exe = "' + $env:CRD_EXE.Replace('"','\"') + '"'
            '$args = @("--code=""' + $env:GCRD_CODE.Replace('"','\"') + '""","--redirect-url=""' + $env:GCRD_REDIRECT.Replace('"','\"') + '""","--name="+$env:COMPUTERNAME,"--pin=' + $env:GCRD_PIN + '")'
            'try {'
            '  $p = Start-Process -FilePath $exe -ArgumentList $args -RedirectStandardOutput "' + $logPath + '" -RedirectStandardError "' + $logPath + '" -NoNewWindow -PassThru -Wait'
            '  "[CRD] ExitCode=" + $p.ExitCode | Out-File -FilePath "' + $logPath + '" -Encoding utf8 -Append'
            '} catch { "[CRD-ERR] " + ($_ | Out-String) | Out-File -FilePath "' + $logPath + '" -Encoding utf8 -Append }'
            'Get-ChildItem "C:\ProgramData\Google\Chrome Remote Desktop" -ErrorAction SilentlyContinue | Out-File -FilePath "' + $logPath + '" -Encoding utf8 -Append'
            'exit 0'
          )
          Set-Content -Path $wrapper -Value $lines -Encoding ASCII
          Write-Host ("ğŸ§© Wrapper created: " + $wrapper)

          # Elevated Scheduled Task (run as chosen admin)
          $task  = "EnigManoCRDRegister"
          $start = (Get-Date).AddMinutes(1).ToString("HH:mm")
          $tr    = 'powershell.exe -NoProfile -ExecutionPolicy Bypass -File "' + $wrapper + '"'
          schtasks /Create /F /RL HIGHEST /SC ONCE /ST $start /TN $task /TR "$tr" /RU "$($env:TARGET_USER)" /RP "$($env:TARGET_PASS)" | Out-Null
          schtasks /Run /TN $task | Out-Null
          Write-Host ("ğŸš€ Registration task launched as " + $env:TARGET_USER)

          # Defensive firewall allow for the host process
          try {
            New-NetFirewallRule -DisplayName "Chrome Remote Desktop Host" -Direction Outbound -Program $env:CRD_EXE -Action Allow -Profile Any -ErrorAction SilentlyContinue | Out-Null
          } catch {}

          # Verify: wait up to ~3 minutes, print log tail, ensure service(s)
          function Ensure-Service($n){
            $s = Get-Service -Name $n -ErrorAction SilentlyContinue
            if ($s -and $s.Status -ne "Running") { try { Start-Service -Name $n } catch {} }
          }

          $ok = $false
          for ($i=1; $i -le 36; $i++) {
            Start-Sleep -Seconds 5

            # Try common CRD service names
            Ensure-Service "chromoting"
            Ensure-Service "ChromeRemoteDesktopService"

            if (Test-Path $logPath) {
              Write-Host "â€”â€” CRD wrapper log snapshot â€”â€”"
              Get-Content $logPath -ErrorAction SilentlyContinue | Select-Object -Last 10
              Write-Host "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"
            }

            $hostPaths = @(
              "C:\ProgramData\Google\Chrome Remote Desktop\host.json",
              "C:\ProgramData\Google\Chrome Remote Desktop\host_unprivileged.json"
            ) | Where-Object { Test-Path $_ }

            if ($hostPaths.Count -gt 0) { $ok = $true; break }
          }

          if ($ok) {
            Write-Host "âœ… CRD host registered (host file present)."
          } else {
            Write-Host "âš ï¸ Host files not detected; most often this means the OAuth code was expired/used. Generate a fresh code and re-run."
          }

          # Cleanup the task (keep wrapper/log for inspection)
          schtasks /Delete /F /TN $task | Out-Null

      # 5) Final Summary (username, password, PIN, links)
      - name: "ğŸ§¾ Connection Summary"
        shell: pwsh
        run: |
          $user = $env:TARGET_USER
          $pass = $env:TARGET_PASS
          $pin  = $env:GCRD_PIN
          $pinMasked = if ($pin.Length -gt 2) { ('*' * ($pin.Length-2)) + $pin.Substring($pin.Length-2) } else { $pin }
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## âœ… EnigMano Remote Access Ready"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Computer Name** : " + $env:COMPUTERNAME)
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **RDP Enabled**   : Yes (firewall opened)")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **User**          : " + $user)
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Password**      : " + $pass)
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **CRD Access**    : https://remotedesktop.google.com/access")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **CRD PIN**       : " + $pinMasked)
          Write-Host ("ğŸ”‘ Credentials -> User=" + $user + " | Pass=" + $pass + " | PIN=" + $pinMasked)
